# ğŸ¨ å·¥è‰ºå±‚æ ‡è®°ä½¿ç”¨æŒ‡å—

## é—®é¢˜è¯´æ˜

å¦‚æœä½ çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºï¼š
```
âš ï¸ [Plugin] No layers found in cache!
ğŸ“Š [Plugin] Stats: craft groups: 0 linked nodes: 0 cache size: 0
```

è¿™æ˜¯**æ­£å¸¸çš„**ï¼è¯´æ˜å½“å‰Figmaæ–‡ä»¶ä¸­è¿˜æ²¡æœ‰æ ‡è®°ä»»ä½•å·¥è‰ºå±‚ã€‚

## å¦‚ä½•æ ‡è®°å·¥è‰ºå±‚

### æ–¹æ³•1ï¼šé€šè¿‡UIæ ‡è®°ï¼ˆæ¨èï¼‰

1. **é€‰æ‹©å›¾å±‚**ï¼šåœ¨Figmaä¸­é€‰æ‹©ä½ æƒ³è¦æ ‡è®°ä¸ºå·¥è‰ºå±‚çš„å›¾å±‚ï¼ˆå¯ä»¥æ˜¯Vectorã€Rectangleã€Frameç­‰ï¼‰

2. **æ‰“å¼€æ’ä»¶**ï¼šè¿è¡Œæ’ä»¶åï¼Œä¼šçœ‹åˆ°å·¥è‰ºæ ‡ç­¾é¡µ

3. **æ ‡è®°å·¥è‰º**ï¼š
   - ç‚¹å‡»å·¥è‰ºç±»å‹æŒ‰é’®ï¼ˆNormalã€Embossã€Goldã€Silverã€UVã€Displaceï¼‰
   - æ’ä»¶ä¼šè‡ªåŠ¨ï¼š
     - åœ¨å›¾å±‚å‘¨å›´åˆ›å»ºå½©è‰²è¾¹æ¡†ï¼ˆå·¥è‰ºæŒ‡ç¤ºå™¨ï¼‰
     - å°†å·¥è‰ºæ•°æ®ä¿å­˜åˆ°å›¾å±‚çš„ pluginData
     - åˆ›å»ºå·¥è‰ºç»„ï¼ˆ`__craft_group_å·¥è‰ºç±»å‹`ï¼‰
     - æ›´æ–°ç¼“å­˜

4. **æŸ¥çœ‹å·²æ ‡è®°çš„å›¾å±‚**ï¼šæ ‡è®°åï¼Œå›¾å±‚ä¼šå‡ºç°åœ¨"é€‰æ‹©å›¾å±‚..."ä¸‹æ‹‰åˆ—è¡¨ä¸­

### æ–¹æ³•2ï¼šé€šè¿‡ä»£ç æ ‡è®°

æ’ä»¶æä¾›äº†ä»¥ä¸‹æ¶ˆæ¯ç±»å‹æ¥æ ‡è®°å·¥è‰ºï¼š

```typescript
// æ ‡è®°é€‰ä¸­çš„å›¾å±‚
figma.ui.postMessage({
  type: 'markCraftWithGray',
  craftType: 'æ³•çº¿', // æˆ– 'UV', 'å‡¹å‡¸', 'çƒ«é‡‘', 'çƒ«é“¶', 'ç½®æ¢'
  grayValue: 128 // 0-255
});

// é€šè¿‡IDæ ‡è®°ç‰¹å®šå›¾å±‚
figma.ui.postMessage({
  type: 'markCraftWithGrayById',
  nodeId: 'node-id-here',
  craftType: 'æ³•çº¿',
  grayValue: 128
});
```

## å·¥è‰ºå±‚çš„å­˜å‚¨æœºåˆ¶

### 1. PluginData å­˜å‚¨
æ¯ä¸ªæ ‡è®°çš„å›¾å±‚ä¼šåœ¨å…¶ `pluginData` ä¸­å­˜å‚¨ï¼š
- `craftTypes`: å·¥è‰ºç±»å‹æ•°ç»„ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
- `grayValue`: ç°åº¦å€¼ï¼ˆ0-1èŒƒå›´ï¼‰
- `craftParams`: å·¥è‰ºå‚æ•°ï¼ˆå¯é€‰ï¼‰

### 2. å·¥è‰ºæŒ‡ç¤ºå™¨ï¼ˆCraft Indicatorsï¼‰
- æ’ä»¶ä¼šåœ¨å›¾å±‚å‘¨å›´åˆ›å»ºå½©è‰²è¾¹æ¡†çŸ©å½¢
- è¾¹æ¡†åç§°æ ¼å¼ï¼š`__craft_indicator_å·¥è‰ºç±»å‹_å›¾å±‚ID`
- è¾¹æ¡†ä¼šè¢«åˆ†ç»„åˆ°å·¥è‰ºç»„ä¸­

### 3. å·¥è‰ºç»„ï¼ˆCraft Groupsï¼‰
- æ‰€æœ‰åŒç±»å‹å·¥è‰ºçš„æŒ‡ç¤ºå™¨ä¼šè¢«æ”¾å…¥ä¸€ä¸ªç»„
- ç»„åç§°æ ¼å¼ï¼š`__craft_group_å·¥è‰ºç±»å‹`
- ç»„ä¼šä¿å­˜åœ¨é¡µé¢é¡¶å±‚æˆ–çˆ¶Frameä¸­

### 4. ç¼“å­˜æœºåˆ¶
- æ’ä»¶ä½¿ç”¨æ‡’åŠ è½½ç¼“å­˜ï¼Œé¿å…å¯åŠ¨æ—¶å…¨é‡éå†
- ç¼“å­˜åˆå§‹åŒ–æ—¶ä¼šæ‰«ææ‰€æœ‰å·¥è‰ºç»„
- é€šè¿‡å·¥è‰ºç»„ä¸­çš„ `linkedNodeId` æ‰¾åˆ°å…³è”çš„å›¾å±‚

## ç¼“å­˜åˆå§‹åŒ–é€»è¾‘

```typescript
// cache.ts: ensureCacheInitialized()
export function ensureCacheInitialized(): void {
  if (cacheInitialized) return;

  const page = figma.currentPage;

  // éå†é¡µé¢é¡¶å±‚èŠ‚ç‚¹ï¼ŒæŸ¥æ‰¾å·¥è‰ºç»„
  for (const child of page.children) {
    if (child.name.startsWith('__craft_group_')) {
      // æ‰¾åˆ°å·¥è‰ºç»„ï¼Œéå†å…¶å­èŠ‚ç‚¹ï¼ˆæŒ‡ç¤ºå™¨ï¼‰
      for (const indicator of child.children) {
        const linkedNodeId = indicator.getPluginData('linkedNodeId');
        if (linkedNodeId) {
          const linkedNode = figma.getNodeById(linkedNodeId);
          if (linkedNode) {
            refreshNodeCache(linkedNode); // åˆ·æ–°ç¼“å­˜
          }
        }
      }
    }
  }

  cacheInitialized = true;
}
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæˆ‘çš„å·¥è‰ºå±‚åˆ—è¡¨æ˜¯ç©ºçš„ï¼Ÿ
A: å› ä¸ºä½ è¿˜æ²¡æœ‰æ ‡è®°ä»»ä½•å›¾å±‚ã€‚è¯·å…ˆé€‰æ‹©å›¾å±‚ï¼Œç„¶åç‚¹å‡»å·¥è‰ºç±»å‹æŒ‰é’®è¿›è¡Œæ ‡è®°ã€‚

### Q: æˆ‘æ ‡è®°äº†å›¾å±‚ï¼Œä½†é‡æ–°æ‰“å¼€æ’ä»¶åæ¶ˆå¤±äº†ï¼Ÿ
A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. å·¥è‰ºç»„æ˜¯å¦è¿˜å­˜åœ¨ï¼ˆåç§°ä»¥ `__craft_group_` å¼€å¤´ï¼‰
2. å›¾å±‚çš„ pluginData æ˜¯å¦è¿˜æœ‰ `craftTypes` æ•°æ®
3. æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

### Q: å¦‚ä½•åˆ é™¤å·¥è‰ºæ ‡è®°ï¼Ÿ
A:
- é€‰æ‹©å·²æ ‡è®°çš„å›¾å±‚ï¼Œç‚¹å‡»"æ¸…é™¤æ ‡è®°"æŒ‰é’®
- æˆ–è€…æ‰‹åŠ¨åˆ é™¤å·¥è‰ºç»„å’Œå›¾å±‚çš„ pluginData

### Q: å·¥è‰ºæŒ‡ç¤ºå™¨ï¼ˆå½©è‰²è¾¹æ¡†ï¼‰å¯ä»¥åˆ é™¤å—ï¼Ÿ
A: å¯ä»¥ï¼Œä½†ä¸æ¨èã€‚åˆ é™¤åç¼“å­˜åˆå§‹åŒ–ä¼šå¤±è´¥ï¼Œéœ€è¦é‡æ–°æ ‡è®°å›¾å±‚ã€‚

## è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ç¼“å­˜çŠ¶æ€
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥æ‰¾ä»¥ä¸‹æ—¥å¿—ï¼š
```
ğŸ”§ [Plugin] ensureCacheInitialized called
ğŸ“„ [Plugin] Current page: xxx children count: xx
ğŸ“Š [Plugin] Stats: craft groups: x linked nodes: x cache size: x
```

### æŸ¥çœ‹å·¥è‰ºç»„
åœ¨Figmaå›¾å±‚é¢æ¿ä¸­ï¼ŒæŸ¥æ‰¾åç§°ä»¥ `__craft_group_` å¼€å¤´çš„ç»„ã€‚

### æŸ¥çœ‹å›¾å±‚æ•°æ®
é€‰æ‹©å›¾å±‚åï¼Œåœ¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
const node = figma.currentPage.selection[0];
console.log('craftTypes:', node.getPluginData('craftTypes'));
console.log('grayValue:', node.getPluginData('grayValue'));
```

## æ€»ç»“

**æ’ä»¶ä¸ä¼šè‡ªåŠ¨è¯†åˆ«å·¥è‰ºå±‚**ï¼Œä½ éœ€è¦ï¼š
1. æ‰‹åŠ¨é€‰æ‹©å›¾å±‚
2. ç‚¹å‡»å·¥è‰ºç±»å‹æŒ‰é’®è¿›è¡Œæ ‡è®°
3. æ’ä»¶ä¼šåˆ›å»ºå·¥è‰ºæŒ‡ç¤ºå™¨å’Œå·¥è‰ºç»„
4. ä¸‹æ¬¡æ‰“å¼€æ’ä»¶æ—¶ï¼Œä¼šä»å·¥è‰ºç»„ä¸­æ¢å¤ç¼“å­˜

è¿™æ˜¯**è®¾è®¡è¡Œä¸º**ï¼Œä¸æ˜¯bugï¼
